<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSTR1 Utility - CA Tanmay Rajendra Bhavar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 40px; background: #f0f2f5; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { color: #1a73e8; border-bottom: 3px solid #1a73e8; padding-bottom: 10px; }
        .upload-section { border: 2px dashed #1a73e8; padding: 50px; text-align: center; margin: 20px 0; border-radius: 10px; background: #f8fbff; cursor: pointer; transition: 0.3s; }
        .upload-section:hover { background: #edf4fe; }
        #status { margin: 20px 0; font-weight: 600; color: #5f6368; }
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; display: none; }
        #b2bBtn { background: #1a73e8; color: white; }
        #b2csBtn { background: #34a853; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h2>GSTR1 Auto-Compiler</h2>
    <p>Professional Utility for <strong>CA Tanmay Rajendra Bhavar</strong></p>
    
    <div class="upload-section" onclick="document.getElementById('fileInput').click()">
        <strong>Click to select 50-100 PDF Invoices</strong>
        <p style="font-size: 0.9em; color: #666;">Data is processed locally and never uploaded to any server.</p>
        <input type="file" id="fileInput" multiple accept=".pdf" style="display:none">
    </div>

    <div id="status">Ready to process...</div>
    
    <div class="btn-group">
        <button id="b2bBtn">Download B2B Template</button>
        <button id="b2csBtn">Download B2CS Template</button>
    </div>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let masterData = [];

    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const files = e.target.files;
        if (files.length === 0) return;

        masterData = [];
        const status = document.getElementById('status');
        const b2bBtn = document.getElementById('b2bBtn');
        const b2csBtn = document.getElementById('b2csBtn');

        for (let i = 0; i < files.length; i++) {
            status.innerText = `Scanning: ${i + 1} / ${files.length}`;
            const text = await extractText(files[i]);
            masterData.push(parseForGST(text));
        }

        status.innerText = `Successfully scanned ${files.length} invoices. Select export format:`;
        b2bBtn.style.display = 'block';
        b2csBtn.style.display = 'block';
    });

    async function extractText(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let text = "";
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            text += content.items.map(item => item.str).join(" ");
        }
        return text;
    }

    function parseForGST(text) {
        return {
            invNo: text.match(/Order\s(R\d+)/)?.[1] || "",
            invDate: formatDate(text.match(/Order date:\s*([\d-]+)/)?.[1]),
            customer: text.match(/Billing Address\s*(.*?)\s*Bhundimuhan/)?.[1] || "Unregistered",
            pos: text.match(/Balangir\s*(.*?)\s*India/)?.[1]?.trim() || "00-Unknown",
            taxableValue: parseFloat(text.match(/Item Total:\s*₹?([\d,.]+)/)?.[1]?.replace(/,/g, '') || 0),
            totalValue: parseFloat(text.match(/Order Total:\s*₹?([\d,.]+)/)?.[1]?.replace(/,/g, '') || 0)
        };
    }

    function formatDate(dateStr) {
        if (!dateStr) return "";
        const [y, m, d] = dateStr.split('-');
        return `${d}-${m}-${y}`; // DD-MM-YYYY format for GST Tool
    }

    // B2B Export Logic
    document.getElementById('b2bBtn').addEventListener('click', () => {
        const b2bRows = masterData.map(d => ({
            "Receiver GSTIN/UIN": "", // Leave blank for manual entry if unknown
            "Receiver Name": d.customer,
            "Invoice Number": d.invNo,
            "Invoice Date": d.invDate,
            "Invoice Value": d.totalValue,
            "Place Of Supply": d.pos,
            "Reverse Charge": "N",
            "Applicable % of Tax Rate": "",
            "Invoice Type": "Regular B2B",
            "E-Commerce GSTIN": "",
            "Rate": 18, // Defaulting to 18%, adjust if necessary
            "Taxable Value": d.taxableValue
        }));
        downloadExcel(b2bRows, "GSTR1_B2B");
    });

    // B2CS Export Logic
    document.getElementById('b2csBtn').addEventListener('click', () => {
        const b2csRows = masterData.map(d => ({
            "Type": "OE",
            "Place Of Supply": d.pos,
            "Applicable % of Tax Rate": "",
            "Rate": 18,
            "Taxable Value": d.taxableValue,
            "Cess Amount": 0,
            "E-Commerce GSTIN": ""
        }));
        downloadExcel(b2csRows, "GSTR1_B2CS");
    });

    function downloadExcel(data, fileName) {
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
        XLSX.writeFile(wb, `${fileName}.xlsx`);
    }
</script>
</body>
</html>
